<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Lost Item - Campus Lost & Found</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="form-container bg-gradient-lost form-transition">
        <div class="form-wrapper">
            <button class="back-button" onclick="goHome()">
                ‚Üê Back to Home
            </button>

            <div class="form-card">
                <h1 class="form-title">Report a Lost Item</h1>
                <p class="form-subtitle">Fill in the details to help others identify your item</p>

                <div id="message-area"></div>

                <form id="lostItemForm" class="space-y-6">
                    <div class="form-group">
                        <label class="form-label">
                            Item Name <span class="required">*</span>
                        </label>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            required
                            class="form-input focus-red"
                            placeholder="e.g., Blue Backpack"
                        />
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Description <span class="required">*</span>
                        </label>
                        <textarea
                            id="description"
                            name="description"
                            required
                            rows="4"
                            class="form-textarea focus-red"
                            placeholder="Describe your item in detail..."
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Location Lost <span class="required">*</span>
                        </label>
                        <input
                            type="text"
                            id="location"
                            name="location"
                            required
                            class="form-input focus-red"
                            placeholder="e.g., Library 2nd Floor"
                        />
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Date Lost <span class="required">*</span>
                        </label>
                        <input
                            type="date"
                            id="date"
                            name="date"
                            required
                            class="form-input focus-red"
                        />
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Photo (Optional)
                        </label>
                        <div class="upload-area" id="uploadArea">
                            <input
                                type="file"
                                id="photo"
                                name="photo"
                                accept="image/*"
                                class="upload-input"
                            />
                            <label for="photo" class="cursor-pointer">
                                <div id="uploadContent">
                                    <div style="font-size: 3rem; margin-bottom: 1rem;">üì∑</div>
                                    <p class="text-gray-600">Click to upload a photo</p>
                                    <p class="text-xs text-gray-500 mt-2">Maximum 2MB, works offline!</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <button
                        type="submit"
                        id="submitButton"
                        class="submit-button"
                    >
                        Submit Lost Item Report
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="js/navigation.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/local-image.js"></script>

    <script>
        let photoFile = null;
        let photoDataUrl = null;
        
        function goHome() {
            window.location.href = 'index.html';
        }
        
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = `<div class="${type === 'error' ? 'error-message' : 'success-message'}">${message}</div>`;
        }
        
        function clearMessage() {
            document.getElementById('message-area').innerHTML = '';
        }

        // Set today as default date
        document.getElementById('date').value = new Date().toISOString().split('T')[0];

        // Handle photo upload
        document.getElementById('photo').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            const uploadContent = document.getElementById('uploadContent');
            
            if (!file) {
                resetPhotoPreview();
                return;
            }

            console.log('üì∑ Photo selected:', file.name, file.size, 'bytes');

            // Validate file
            const validation = LocalImageAPI.validateImageFile(file);
            if (!validation.isValid) {
                showMessage('Photo Error: ' + validation.errors.join(', '), 'error');
                resetPhotoPreview();
                return;
            }

            try {
                clearMessage();
                photoFile = file;
                
                // Convert to base64 for preview and storage
                photoDataUrl = await LocalImageAPI.createPreviewUrl(file);
                console.log('‚úÖ Photo processed successfully');
                
                // Show preview
                uploadContent.innerHTML = `
                    <img src="${photoDataUrl}" alt="Preview" class="upload-preview" />
                    <p class="text-gray-600">Click to change photo</p>
                    <p class="text-xs text-green-600">‚úÖ Photo ready for upload</p>
                `;
                
            } catch (error) {
                console.error('‚ùå Photo processing failed:', error);
                showMessage('Failed to process image: ' + error.message, 'error');
                resetPhotoPreview();
            }
        });

        function resetPhotoPreview() {
            photoFile = null;
            photoDataUrl = null;
            document.getElementById('uploadContent').innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1rem;">üì∑</div>
                <p class="text-gray-600">Click to upload a photo</p>
                <p class="text-xs text-gray-500 mt-2">Maximum 2MB, works offline!</p>
            `;
        }

        // Handle form submission
        document.getElementById('lostItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitButton');
            const originalText = submitButton.textContent;
            
            try {
                clearMessage();
                submitButton.textContent = 'Submitting...';
                submitButton.disabled = true;
                
                console.log('üìù Submitting lost item...');

                // Get form data
                const formData = new FormData(e.target);
                const itemData = {
                    name: formData.get('name').trim(),
                    description: formData.get('description').trim(),
                    location: formData.get('location').trim(),
                    date: formData.get('date'),
                    status: 'Lost',
                    photo_url: photoDataUrl // Use base64 data URL instead of Cloudinary URL
                };

                // Validate data
                const validation = SupabaseAPI.validateItem(itemData);
                if (!validation.isValid) {
                    throw new Error(validation.errors.join(', '));
                }

                console.log('üíæ Saving to database...');
                
                // Create item in database
                await SupabaseAPI.createItem(itemData);
                
                console.log('‚úÖ Item saved successfully!');
                showMessage('‚úÖ Lost item reported successfully!', 'success');
                
                // Reset form after short delay
                setTimeout(() => {
                    window.location.href = 'dashboard-simple.html';
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Submission failed:', error);
                showMessage('Failed to submit: ' + error.message, 'error');
            } finally {
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        });
        
        console.log('üì± Lost item form loaded and ready!');
    </script>
</body>
</html>